<!-- index.html LEVE -->
<!DOCTYPE html>
<html>
<body>
<canvas id="tela"></canvas>

<script>
const canvas = document.getElementById('tela');
const ctx = canvas.getContext('2d');
const ws = new WebSocket('ws://localhost:8765');

// Buffer para reutilização de memória
let imageBuffer = null;

ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'frame_compressed') {
        // Descomprime
        const compressed = Uint8Array.from(atob(data.data), c => c.charCodeAt(0));
        const decompressed = pako.inflate(compressed); // Usa pako.js para zlib

        // Cria blob sem acumular memória
        const blob = new Blob([decompressed], {type: 'image/jpeg'});
        const url = URL.createObjectURL(blob);

        const img = new Image();
        img.onload = () => {
            canvas.width = data.w;
            canvas.height = data.h;
            ctx.drawImage(img, 0, 0);

            // Limpa memória
            URL.revokeObjectURL(url);
            img.src = '';
        };
        img.src = url;
    }
};

// Usa pako.js para descompressão zlib
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js';
document.head.appendChild(script);
</script>
</body>
</html>
